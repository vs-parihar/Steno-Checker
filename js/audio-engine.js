const $A=i=>document.getElementById(i);let ac,sr,gn,bpAb=null;window.is=0;window.upV=()=>{if(gn)gn.gain.value=$A('vl').value};window.updatePlBtn=()=>{const b=$A('pl');b.classList.toggle('pausing',!!window.is);b.innerHTML=window.is?'<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>':'<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'};$A('pl').onclick=async()=>{const au=$A('au');if($A('pl').disabled)return;if(!ac){ac=new AudioContext();sr=ac.createMediaElementSource(au);gn=ac.createGain();sr.connect(gn);gn.connect(ac.destination);upV()}if(window.is){au.pause();window.is=0}else{if($A('bp').checked&&au.currentTime<0.5){$A('pl').disabled=true;bpAb=new AbortController();try{await beeps(bpAb.signal)}catch(e){$A('pl').disabled=false;return}$A('pl').disabled=false}await ac.resume();au.play();window.is=1}updatePlBtn()};$A('sb').onclick=()=>{const au=$A('au');if(bpAb)bpAb.abort();au.pause();au.currentTime=0;window.is=0;updatePlBtn();$A('pl').disabled=false};async function beeps(s){for(let i=0;i<5;i++){if(s.aborted)return;const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);g.gain.value=$A('vl').value*0.5;o.frequency.value=i===4?1200:880;o.start();o.stop(ac.currentTime+(i===4?0.5:0.1));await new Promise(r=>setTimeout(r,1000))}}window.sk=s=>{const au=$A('au');au.currentTime+=s};window.expA=async()=>{const au=$A('au'),b=$A('exB'),r=parseFloat($A('ri').value);b.innerText='⌛';try{const res=await fetch(au.src),buf=await res.arrayBuffer(),ctx=new OfflineAudioContext(2,buf.byteLength/r,44100),sBuf=await ctx.decodeAudioData(buf),src=ctx.createBufferSource();src.buffer=sBuf;src.playbackRate.value=r;src.connect(ctx.destination);src.start();const ren=await ctx.startRendering(),blob=new Blob([toWav(ren)],{type:'audio/wav'}),name='WPM'+Math.round($A('wi').value);const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name+'.wav';a.click()}catch(e){}finally{b.innerText='⬇️'}};function toWav(b){let n=b.numberOfChannels,len=b.length*n*2+44,buf=new ArrayBuffer(len),v=new DataView(buf),p=44;const s=(t,x)=>{for(let i=0;i<x.length;i++)v.setUint8(t+i,x.charCodeAt(i))};s(0,'RIFF');v.setUint32(4,len-8,true);s(8,'WAVE');s(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,n,true);v.setUint32(24,b.sampleRate,true);v.setUint32(28,b.sampleRate*n*2,true);v.setUint16(32,n*2,true);v.setUint16(34,16,true);s(36,'data');v.setUint32(40,len-44,true);for(let i=0;i<b.length;i++)for(let c=0;c<n;c++){let x=Math.max(-1,Math.min(1,b.getChannelData(c)[i]));v.setInt16(p,x<0?x*0x8000:x*0x7FFF,true);p+=2}return buf}