function hL(id){document.querySelectorAll('.ctx-hl').forEach(e=>e.classList.remove('ctx-hl'));document.querySelectorAll('.hl').forEach(e=>e.classList.remove('hl'));const el=$('le-'+id),dl=$('de-'+id);if(dl){dl.scrollIntoView({behavior:'smooth',block:'center'});dl.classList.add('hl');let p=dl.previousElementSibling,n=dl.nextElementSibling;for(let i=0;i<2;i++){if(p){p.classList.add('ctx-hl');p=p.previousElementSibling}if(n){n.classList.add('ctx-hl');n=n.nextElementSibling}}}if(el){el.classList.add('hl');el.scrollIntoView({behavior:'smooth',block:'center'})}};
function tN(){isN=!isN;$('nb').classList.toggle('active',isN);uD()}
function msg(t,cb){$('msgT').innerText=t;$('msgB').innerHTML=cb?`<button onclick="(${cb})();$('msgM').classList.remove('active')" style="border-color:var(--gr)">OK</button><button onclick="$('msgM').classList.remove('active')" style="border-color:var(--re)">Cancel</button>`:`<button onclick="$('msgM').classList.remove('active')">OK</button>`;$('msgM').classList.add('active')}

function svSt(){
    const eS={};ets.forEach(t=>eS[t]=$(`c-${t.replace(/[ /+]/g,'_')}`).value);
    const s={tx:$('tx').value,vl:$('vl').value,wi:$('wi').value,ri:$('ri').value,wcM:$('wcM').value,as:$('as').checked,bp:$('bp').checked,tm:document.body.classList.contains('light-mode'),curI,lU:au.src.startsWith('blob')?'':au.src,lT:au.currentTime,exMd,tLim,tEl,st:started,trV:$('trI').value,trO:$('trM').classList.contains('active'),eS,exP:$('exP').value,exT:$('exT').value,exW:$('exW').value,exMM:$('exMM').value};
    localStorage.setItem('st',JSON.stringify(s))
}

function ldSt(){
    try{const s=JSON.parse(localStorage.getItem('st')),h=JSON.parse(localStorage.getItem('hist'));if(h)hist=h;if(s){$('tx').value=s.tx||'';$('vl').value=s.vl||1;$('wi').value=s.wi||'80';$('ri').value=s.ri||'1.0000';$('wcM').value=s.wcM||'0';$('as').checked=!!s.as;$('bp').checked=!!s.bp;curI=s.curI??-1;if(s.tm)document.body.classList.add('light-mode');document.querySelectorAll('.th-chk').forEach(x=>x.checked=!!s.tm);if(s.lU){au.src=s.lU;if(s.lT)au.currentTime=Math.max(0,s.lT-5)}$('exMode').value=exMd=s.exMd||'prac';tLim=s.tLim||10;$('trI').value=s.trV||'';$('exP').value=s.exP||'def';$('exT').value=s.exT||10;$('exW').value=s.exW||80;$('exMM').value=s.exMM||100;if(s.eS)ets.forEach(t=>{$(`c-${t.replace(/[ /+]/g,'_')}`).value=s.eS[t]||'S'});if(s.trO){opTr();if(s.st){tEl=s.tEl+5;tS=Date.now()-tEl*1000;started=1;stTmr()}}if(exMd==='mock')stEx(true)}}catch(e){}
}

function resetData(){$('tx').value='';$('stTitle').innerText='No Audio';if(lastAuSrc)URL.revokeObjectURL(lastAuSrc);$('wc').value=0;$('st').innerText='Ready';$('trI').value='';$('resBox').style.display='none';$('rS').innerHTML='';upWC();if(is)au.pause();is=0;updatePlBtn();started=0;if(tmr)clearInterval(tmr);$('tmD').disabled=false;$('tmC').disabled=false;played80=0}
function updatePlBtn(){$('pl').innerHTML=is?'<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>':'<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';if(is)$('pl').classList.add('pausing');else $('pl').classList.remove('pausing')}
function sTm(v){if(v=='-1'){$('tmC').style.display='block';$('tmD').style.display='none';$('tmC').focus()}else{tLim=parseInt(v);$('tmR').textContent=tLim?tLim+":00":"00:00";if(tmr){clearInterval(tmr);tmr=null;started=0;}$('tmR').className='tm-gr';tEl=0;if(v=='-1')tLim=parseInt($('tmC').value);if(exMd==='mock')$('mkTr').textContent=$('tmR').textContent}}
function tTh(){document.body.classList.toggle('light-mode');let c=document.body.classList.contains('light-mode');document.querySelectorAll('.th-chk').forEach(x=>x.checked=c);svSt()}
function adj(k,v){if(k==='sc'){curS=Math.max(0.5,Math.min(1.5,curS+v));document.documentElement.style.setProperty('--sc',curS)}else{curT=Math.max(10,Math.min(48,curT+v));document.documentElement.style.setProperty('--ts',curT+'px')}}
function openM(){$('md').classList.toggle('active')}
function uSl(t,v){let val=parseInt(v)||0;if(t==='min'){$('wMin').value=val;$('slMi').value=val}else{$('wMax').value=val;$('slMa').value=val}renL()}
function setP(v){const[min,max]=v.split('-');uSl('min',min);uSl('max',max==='max'?maxW:max)}
function tDD(){$('ddF').style.display=$('ddF').style.display==='flex'?'none':'flex'}
function opLnk(){$('lnkM').classList.add('active')}
function opTr(){if(!$('tx').value.trim()){msg("First have text");return}if(is){au.pause();is=0;updatePlBtn()}$('trM').classList.add('active');$('trV').style.display='flex';$('rsV').style.display='none';$('trI').value=$('trI').value||'';$('trI').focus();$('trTi').textContent=$('stTitle').textContent;if(tLim>0)$('tmD').value=tLim;svSt()}

async function lG(u){let list=[];try{for(let r of(u?[regs.find(x=>x.u===u)]:regs)){const res=await fetch(`https://gist.githubusercontent.com/vs-parihar/${r.u}/raw?t=${Date.now()}`);const j=await res.json();if(Array.isArray(j))list=list.concat(j.map(i=>({...i,reg:r.t})))}}catch(e){}lD(list);renT();renL()}
function lD(list){maxW=0;curL=list.map((i,idx)=>{let m=i.title.match(/WORDS\s*(\d+)/i),w=i.w||[],b=Math.max(...w,m?parseInt(m[1]):0);if(b>maxW)maxW=b;return{...i,_id:idx,maxW:b,tags:(i.tags||[]).map(t=>t.toUpperCase())}});$('slMi').max=$('slMi').value=$('slMa').max=$('slMa').value=maxW;uSl('min',0);uSl('max',maxW)}
function renT(){const t=$('tags'),set=new Set();curL.forEach(i=>i.tags.forEach(g=>set.add(g)));t.innerHTML='';Array.from(set).sort().forEach(g=>{let s=document.createElement('span');s.className='filter-chip';s.textContent=g;s.onclick=()=>{s.classList.toggle('active');renL()};t.appendChild(s)})}
function renL(){const mi=parseInt($('wMin').value)||0,ma=parseInt($('wMax').value)||maxW,at=Array.from(document.querySelectorAll('.filter-chip.active')).map(x=>x.textContent),so=$('srt').value,sq=$('libS').value.toLowerCase(),wm=$('wcM').value,map=[1,0,2];filtL=curL.filter(i=>{const v=i.maxW||0;return(v>=mi&&v<=ma)&&(at.length===0||at.every(t=>i.tags.includes(t)))&&(!sq||i.title.toLowerCase().includes(sq))});if(so==='on')filtL.sort((a,b)=>a._id-b._id);if(so==='no')filtL.sort((a,b)=>b._id-a._id);if(so==='az')filtL.sort((a,b)=>a.title.localeCompare(b.title));$('ls').innerHTML='';filtL.forEach((i,idx)=>{let d=document.createElement('div');d.className='list-item';d.id='row-'+idx;let id=i.url?.split('details/')[1],hc=hist[id]?` <b style="color:var(--gr)">(${hist[id]})</b>`:'';let wc=i.w?i.w[map[wm]]:i.maxW;d.innerHTML=`<div style="font-weight:500">${i.title}</div><div style="font-size:9px;opacity:0.7">${wc} words â€¢ ${fT(i.dur||0)}${hc}</div>`;d.onclick=()=>lA(i,idx);$('ls').appendChild(d)})}
async function lA(i,idx){curI=idx;curO=i;$('md').classList.remove('active');$('tx').value="Loading...";played80=0;const wm=$('wcM').value,map=[1,0,2],v=i.w?i.w[map[wm]]:i.maxW;if(v){$('wc').value=v;$('st').innerText='W: '+v;if(i.dur){$('wi').value=(fixW>0?fixW:(v/(i.dur/60)).toFixed(2));$('ri').value="1.0000";}}const id=i.url?.split('details/')[1],dl=`https://archive.org/download/${id}/`;let auSrc=i.audio;try{if(id){const mr=await fetch(`https://archive.org/metadata/${id}`),md=await mr.json(),fs=md.files||[];const mf=fs.find(f=>f.name.endsWith('.mp3')),of=fs.find(f=>f.name.match(/\.(wav|m4a|ogg|aac)$/i)),tf=fs.find(f=>f.name.endsWith('.txt')||f.name.endsWith('.md'));if(mf)auSrc=dl+mf.name;else if(of)auSrc=dl+of.name;if(i.matter){const r=await fetch(i.matter);$('tx').value=await r.text()}else if(tf){const r=await fetch(dl+tf.name);$('tx').value=await r.text()}else{$('tx').value=md.metadata.description?.replace(/<[^>]*>?/gm,'')||"No text"}}}catch(e){if(!i.matter)$('tx').value="Text Load Fail"}au.src=auSrc;au.load();$('stTitle').innerText=i.title;upWC();svSt();if(exNext)stEx()}
async function ldLnk(){const u=$('lnkV').value;if(u){$('lnkM').classList.remove('active');resetData();if(u.includes('archive.org')){const id=u.split('details/')[1];if(id){try{const m=await fetch(`https://archive.org/metadata/${id}`).then(r=>r.json());const f=m.files,mp3=f.find(x=>x.name.endsWith('.mp3')),txt=f.find(x=>x.name.endsWith('.txt'));if(mp3)au.src=`https://archive.org/download/${id}/${mp3.name}`;if(txt)$('tx').value=await fetch(`https://archive.org/download/${id}/${txt.name}`).then(r=>r.text());$('stTitle').innerText=m.metadata.title;upWC()}catch(e){}}}else au.src=u;upWC();svSt();if(exNext)stEx()}}
function stepTrk(n){if(!filtL.length){if(curL.length)filtL=curL;else return}let l=filtL.length;if(!l)return;let x=curI+n;if(x>=0&&x<l)lA(filtL[x],x)}

function init(){
    regs.forEach(r=>{let o=document.createElement('option');o.value=r.u;o.textContent=r.t;$('rg').appendChild(o)});
    [40,50,60,80,90,100,120,140,160,180,200].forEach(v=>{let o=document.createElement('option');o.value=v;o.textContent=v;$('ws').appendChild(o)});
    [0.8,1,1.2,1.5].forEach(v=>{let o=document.createElement('option');o.value=v;o.textContent=v;$('rs').appendChild(o)});
    $('rg').onchange=e=>lG(e.target.value);
    $('f').onchange=async e=>{resetData();for(const f of Array.from(e.target.files)){if(f.type.includes('audio')){lastAuSrc=URL.createObjectURL(f);au.src=lastAuSrc;$('stTitle').innerText=f.name}else if(f.name.match(/\.(txt|md)$/i)||f.type.includes('text')){$('tx').value=await f.text();upWC(true)}}svSt();if(exNext)stEx()};
    lG(null);
    const cH=document.querySelector('.ctrl-grp').innerHTML;$('mdC').innerHTML=cH;$('trC').innerHTML=cH;ldSt();
    const g=$('exC');ets.forEach((t,i)=>{const d=document.createElement('div');d.className=`eg-i ${i>3?'hd-err':''}`;d.innerHTML=`<label>${t}</label><select id="c-${t.replace(/[ /+]/g,'_')}" onchange="svSt()"><option value="H">H</option><option value="S" ${['Substitution','Missing','Insertion'].includes(t)?'selected':''}>S</option><option value="D">D</option><option value="X" ${t.includes('Space')?'selected':''}>X</option></select>`;g.appendChild(d)});
    g.innerHTML+='<div class="more-tg" onclick="document.querySelectorAll(\'.hd-err\').forEach(e=>e.classList.toggle(\'show\'))">Show More/Less</div>';upWC()
}

$('wi').oninput=()=>sync('w');
$('ri').oninput=()=>sync('r');
au.onloadedmetadata=()=>{if(fixW>0){const w=parseFloat($('wc').value),m=au.duration/60;if(w&&m){$('wi').value=fixW;$('ri').value=(fixW/(w/m)).toFixed(4);au.playbackRate=parseFloat($('ri').value);updateStatus()}}else sync('r');$('tm').textContent=`${fT(0)}/${fT(au.duration/au.playbackRate)}`;svSt();if(exNext)stEx()}
$('pb').onclick=e=>{if(exMd==='mock')return;const r=$('pb').getBoundingClientRect();au.currentTime=((e.clientX-r.left)/r.width)*au.duration};
window.onclick=e=>{if(!e.target.matches('.dd-item')&&!e.target.matches('button'))$('ddF').style.display='none'}
window.onload=init;